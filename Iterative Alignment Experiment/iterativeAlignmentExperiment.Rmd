---
title: "Iterative Alignment Experiment"
author: "Joe Zemmels"
date: "4/2/2021"
output: html_document
---

```{r,setup}
library(tidyverse)
library(cmcR)
library(x3ptools)
source("~/cmas/cmas Functions/cmasFunctions.R")
```

```{r}
sensofarFilesGroup4 <- list.files("~/cmas/DFSC Scans/Sensofar Scans/Group004_masked/",pattern = "*.x3p",full.names = TRUE)

future::plan(future::multisession(workers = future::availableCores() - 10))

sensofarFilesGroup4 <- sensofarFilesGroup4[-11]

sensofarNamesGroup4 <- purrr::map_chr(sensofarFilesGroup4,
                                      function(fileName){
                                        paste0("group4_",str_extract(fileName,pattern = "P00[0-9]{1,2}"))
                                      })

sensofarProcessedGroup4_masked <- furrr::future_pmap(.l = list(sensofarFilesGroup4),
                                                     function(fileName){
                                                       
                                                       print(fileName)
                                                       
                                                       dat <- x3p_read(fileName)
                                                       
                                                       maskBackground <- toupper(dat$matrix.info$Mask$Background[[1]])
                                                       
                                                       if(all(str_length(unique(as.vector(dat$mask))) > 7) & any(str_detect(unique(as.vector(dat$mask)),"FF$"))){
                                                         
                                                         maskBackground <- paste0(maskBackground,"FF")
                                                         
                                                       }
                                                       
                                                       dat <- dat %>%
                                                         x3p_delete(mask_vals = maskBackground) %>%
                                                         preProcess_removeTrend(statistic = "quantile",
                                                                                tau = .5,
                                                                                method = "fn") %>%
                                                         preProcess_gaussFilter() %>% 
                                                         x3p_sample() %>% 
                                                         preProcess_removeTrend(statistic = "quantile",
                                                                                tau = .5,
                                                                                method = "fn") %>%
                                                         preProcess_gaussFilter() %>% 
                                                         x3p_sample() %>%
                                                         cmcR:::preProcess_cropWS()
                                                       
                                                       dat$mask <- NULL
                                                       
                                                       return(dat)
                                                       
                                                     }) %>%
  set_names(sensofarNamesGroup4)

future:::ClusterRegistry("stop")

x3pListPlot(sensofarProcessedGroup4_masked,
            type = "list")
```

```{r}
load("~/cmas/DFSC Pre-Rotate Scans by Polar Domain Estimation Experiment/DFSC_64Cells_comparisonData.RData")
# rm(sensofarGroup4Comparisons_64Cells)
rm(topMatchGroup4Comparisons_64Cells)
rm(crossGroup4Comparisons_64Cells)
```


```{r}
future::plan(future::multisession(workers = future::availableCores() - 10))

# sensofarGroup4Comparisons_64Cells_alignedOnce <- 
furrr::future_map(1:length(sensofarProcessedGroup4_masked),
# purrr::map(1:length(sensofarProcessedGroup4_masked),
           function(refInd){
             furrr::future_map(1:length(sensofarProcessedGroup4_masked),
             # purrr::map(1:length(sensofarProcessedGroup4_masked),
                        function(targetInd){
                          
                          # browser()
                          
                          refName <- names(sensofarProcessedGroup4_masked[refInd])
                          targetName <- names(sensofarProcessedGroup4_masked[targetInd])
                          
                          ref <- sensofarProcessedGroup4_masked[[refInd]]
                          target <- sensofarProcessedGroup4_masked[[targetInd]]
                          
                          phaseAlignment <- sensofarGroup4Comparisons_64Cells[[refInd]][[targetInd]]$comparisonData %>%
                            group_by(cellIndex,direction) %>%
                            filter(pairwiseCompCor == max(pairwiseCompCor) & pairwiseCompCor >= .5) %>%
                            ungroup() %>%
                            mutate(theta = ifelse(direction == "targetToRef",-theta,theta),
                                   x = ifelse(direction == "targetToRef",-x,x),
                                   y = ifelse(direction == "targetToRef",-y,y)) %>%
                            summarise(theta = median(theta),
                                      x = median(x),
                                      y = median(y))
                          
                          target <- scanPhaseShift(target,
                                                   rotation = phaseAlignment$theta,
                                                   rowTranslation = phaseAlignment$y,
                                                   colTranslation = phaseAlignment$x)
                          
                          print(paste0(refName," vs. ",targetName))
                          
                          refToTargetComparison <- tryCatch({
                            map_dfr(seq(-30,30,by = 3),
                                    function(theta){
                                      comparison_allTogether(reference = ref,
                                                             target = target,
                                                             theta = theta,
                                                             numCells = 64)
                                    })  %>%
                              mutate(direction = "refToTarget",
                                     comparisonName = paste0(refName," vs. ",targetName))
                          },
                          error = function(e){
                            data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                       comparisonName = paste0(refName," vs. ",targetName),direction = "refToTarget")
                          })
                          
                          targetToRefComparison <- tryCatch(expr = {
                            map_dfr(seq(-30,30,by = 3),
                                    function(theta){
                                      comparison_allTogether(reference = target,
                                                             target = ref,
                                                             theta = theta,
                                                             numCells = 64)
                                    })  %>%
                              mutate(direction = "targetToRef",
                                     comparisonName = paste0(refName," vs. ",targetName))
                          },
                          error = function(e){
                            data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                       comparisonName = paste0(refName," vs. ",targetName),direction = "targetToRef")
                          })
                          
                          comparisonData <- bind_rows(refToTargetComparison,
                                                      targetToRefComparison)
                          if(!any(is.na(comparisonData$cellIndex))){
                            
                            CMCs <- purrr::map_dfr(cross(.l = list("x" = seq(5,25,by = 5),
                                                                   # "y" = seq(5,25,by = 5),
                                                                   "corr" = seq(.3,.6,by = .05))),
                                                   function(thresholds){
                                                     
                                                     comparisonData %>%
                                                       group_by(comparisonName,
                                                                direction) %>%
                                                       mutate(originalMethodClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                   x = x,
                                                                                                   y = y,
                                                                                                   theta = theta,
                                                                                                   corr = pairwiseCompCor,
                                                                                                   xThresh = thresholds$x,
                                                                                                   yThresh = thresholds$x,
                                                                                                   corrThresh = thresholds$corr,
                                                                                                   thetaThresh = 6),
                                                              highCMCClassif = decision_CMC(cellIndex = cellIndex,
                                                                                            x = x,
                                                                                            y = y,
                                                                                            theta = theta,
                                                                                            corr = pairwiseCompCor,
                                                                                            xThresh = thresholds$x,
                                                                                            yThresh = thresholds$x,
                                                                                            corrThresh = thresholds$corr,
                                                                                            thetaThresh = 6,
                                                                                            tau = 1)) %>%
                                                       ungroup() %>%
                                                       mutate(type = "match",
                                                              xThresh = thresholds$x,
                                                              yThresh = thresholds$x,
                                                              corrThresh = thresholds$corr,
                                                              thetaThresh = 6)
                                                     
                                                   })
                          }
                          else{
                            CMCs <- comparisonData %>%
                              mutate(originalMethodCount = NA,
                                     highCMCCount = NA,
                                     type = "match",
                                     xThresh = NA,
                                     yThresh = NA,
                                     corrThresh = NA,
                                     thetaThresh = NA)
                          }
                          
                          ret <- list("comparisonData" = comparisonData,
                                      "CMCs" = CMCs)
                          retName <- paste0("~/cmas/Iterative Alignment Experiment/sensofarAlignedOnceComparisonData/",
                                            paste0(refName,"_vs_",targetName),".Rdata") 
                          
                          save(ret,
                               file = retName)
                          
                          # return(list("comparisonData" = comparisonData,
                          #             "CMCs" = CMCs))
                          
                        })
           })

future:::ClusterRegistry("stop")
```


Repeat again with previously aligned values

```{r}
future::plan(future::multisession(workers = future::availableCores() - 10))

# sensofarGroup4Comparisons_64Cells_alignedOnce <- 
furrr::future_map(1:length(sensofarProcessedGroup4_masked),
                  # purrr::map(1:length(sensofarProcessedGroup4_masked),
                  function(refInd){
                    furrr::future_map(1:length(sensofarProcessedGroup4_masked),
                                      # purrr::map(1:length(sensofarProcessedGroup4_masked),
                                      function(targetInd){
                                        
                                        # browser()
                                        
                                        refName <- names(sensofarProcessedGroup4_masked[refInd])
                                        targetName <- names(sensofarProcessedGroup4_masked[targetInd])
                                        
                                        ref <- sensofarProcessedGroup4_masked[[refInd]]
                                        target <- sensofarProcessedGroup4_masked[[targetInd]]
                                        
                                        #load previous iteration's alignment data
                                        load(paste0("~/cmas/Iterative Alignment Experiment/sensofarAlignedOnceComparisonData/",
                                                    paste0(refName,"_vs_",targetName),".Rdata"))
                                        
                                        phaseAlignment <- ret$comparisonData %>%
                                          group_by(cellIndex,direction) %>%
                                          filter(pairwiseCompCor == max(pairwiseCompCor) & pairwiseCompCor >= .5) %>%
                                          ungroup() %>%
                                          mutate(theta = ifelse(direction == "targetToRef",-theta,theta),
                                                 x = ifelse(direction == "targetToRef",-x,x),
                                                 y = ifelse(direction == "targetToRef",-y,y)) %>%
                                          summarise(theta = median(theta),
                                                    x = median(x),
                                                    y = median(y))
                                        
                                        target <- scanPhaseShift(target,
                                                                 rotation = phaseAlignment$theta,
                                                                 rowTranslation = phaseAlignment$y,
                                                                 colTranslation = phaseAlignment$x)
                                        
                                        print(paste0(refName," vs. ",targetName))
                                        
                                        refToTargetComparison <- tryCatch({
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = ref,
                                                                           target = target,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "refToTarget",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "refToTarget")
                                        })
                                        
                                        targetToRefComparison <- tryCatch(expr = {
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = target,
                                                                           target = ref,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "targetToRef",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "targetToRef")
                                        })
                                        
                                        comparisonData <- bind_rows(refToTargetComparison,
                                                                    targetToRefComparison)
                                        if(!any(is.na(comparisonData$cellIndex))){
                                          
                                          CMCs <- purrr::map_dfr(cross(.l = list("x" = seq(5,25,by = 5),
                                                                                 # "y" = seq(5,25,by = 5),
                                                                                 "corr" = seq(.3,.6,by = .05))),
                                                                 function(thresholds){
                                                                   
                                                                   comparisonData %>%
                                                                     group_by(comparisonName,
                                                                              direction) %>%
                                                                     mutate(originalMethodClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                                 x = x,
                                                                                                                 y = y,
                                                                                                                 theta = theta,
                                                                                                                 corr = pairwiseCompCor,
                                                                                                                 xThresh = thresholds$x,
                                                                                                                 yThresh = thresholds$x,
                                                                                                                 corrThresh = thresholds$corr,
                                                                                                                 thetaThresh = 6),
                                                                            highCMCClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                          x = x,
                                                                                                          y = y,
                                                                                                          theta = theta,
                                                                                                          corr = pairwiseCompCor,
                                                                                                          xThresh = thresholds$x,
                                                                                                          yThresh = thresholds$x,
                                                                                                          corrThresh = thresholds$corr,
                                                                                                          thetaThresh = 6,
                                                                                                          tau = 1)) %>%
                                                                     ungroup() %>%
                                                                     mutate(type = "match",
                                                                            xThresh = thresholds$x,
                                                                            yThresh = thresholds$x,
                                                                            corrThresh = thresholds$corr,
                                                                            thetaThresh = 6)
                                                                   
                                                                 })
                                        }
                                        else{
                                          CMCs <- comparisonData %>%
                                            mutate(originalMethodCount = NA,
                                                   highCMCCount = NA,
                                                   type = "match",
                                                   xThresh = NA,
                                                   yThresh = NA,
                                                   corrThresh = NA,
                                                   thetaThresh = NA)
                                        }
                                        
                                        ret <- list("comparisonData" = comparisonData,
                                                    "CMCs" = CMCs)
                                        retName <- paste0("~/cmas/Iterative Alignment Experiment/sensofarAlignedTwiceComparisonData/",
                                                          paste0(refName,"_vs_",targetName),".Rdata") 
                                        
                                        save(ret,
                                             file = retName)
                                        
                                        # return(list("comparisonData" = comparisonData,
                                        #             "CMCs" = CMCs))
                                        
                                      })
                  })

future:::ClusterRegistry("stop")
```



Now do with Top Match data



```{r}
topMatchFilesGroup4 <- list.files("~/cmas/DFSC Scans/TopMatch Scans/Group004_masked/",pattern = "*.x3p",full.names = TRUE)

future::plan(future::multisession(workers = future::availableCores() - 10))

# topMatchFilesGroup4 <- topMatchFilesGroup4[-11]

topMatchNamesGroup4 <- purrr::map_chr(topMatchFilesGroup4,
                                      function(fileName){
                                        paste0("group4_",str_extract(fileName,pattern = "K004[a-z][A-Z][0-9]{1,}"))
                                      })

topMatchProcessedGroup4_masked <- furrr::future_pmap(.l = list(topMatchFilesGroup4),
                                                     function(fileName){
                                                       
                                                       print(fileName)
                                                       
                                                       dat <- x3p_read(fileName)
                                                       
                                                       maskBackground <- toupper(dat$matrix.info$Mask$Background[[1]])
                                                       
                                                       if(all(str_length(unique(as.vector(dat$mask))) > 7) & any(str_detect(unique(as.vector(dat$mask)),"FF$"))){
                                                         
                                                         maskBackground <- paste0(maskBackground,"FF")
                                                         
                                                       }
                                                       
                                                       dat <- dat %>%
                                                         x3p_delete(mask_vals = maskBackground) %>%
                                                         preProcess_removeTrend(statistic = "quantile",
                                                                                tau = .5,
                                                                                method = "fn") %>%
                                                         preProcess_gaussFilter() %>% 
                                                         x3p_sample() %>% 
                                                         preProcess_removeTrend(statistic = "quantile",
                                                                                tau = .5,
                                                                                method = "fn") %>%
                                                         preProcess_gaussFilter() %>% 
                                                         x3p_sample() %>%
                                                         cmcR:::preProcess_cropWS()
                                                       
                                                       dat$mask <- NULL
                                                       
                                                       return(dat)
                                                       
                                                     }) %>%
  set_names(topMatchNamesGroup4)

future:::ClusterRegistry("stop")

# topMatchProcessedGroup4_masked <- topMatchProcessedGroup4_masked[-11]

x3pListPlot(topMatchProcessedGroup4_masked,
            type = "list")
```

```{r}
load("~/cmas/DFSC Pre-Rotate Scans by Polar Domain Estimation Experiment/DFSC_64Cells_comparisonData.RData")
rm(sensofarGroup4Comparisons_64Cells)
# rm(topMatchGroup4Comparisons_64Cells)
rm(crossGroup4Comparisons_64Cells)
```

```{r}
future::plan(future::multisession(workers = future::availableCores() - 10))

# topMatchGroup4Comparisons_64Cells_alignedOnce <- 
furrr::future_map(1:length(topMatchProcessedGroup4_masked),
                  # purrr::map(1:length(topMatchProcessedGroup4_masked),
                  function(refInd){
                    furrr::future_map(1:length(topMatchProcessedGroup4_masked),
                                      # purrr::map(1:length(topMatchProcessedGroup4_masked),
                                      function(targetInd){
                                        
                                        # browser()
                                        
                                        refName <- names(topMatchProcessedGroup4_masked[refInd])
                                        targetName <- names(topMatchProcessedGroup4_masked[targetInd])
                                        
                                        ref <- topMatchProcessedGroup4_masked[[refInd]]
                                        target <- topMatchProcessedGroup4_masked[[targetInd]]
                                        
                                        phaseAlignment <- topMatchGroup4Comparisons_64Cells[[refInd]][[targetInd]]$comparisonData %>%
                                          group_by(cellIndex,direction) %>%
                                          filter(pairwiseCompCor == max(pairwiseCompCor) & pairwiseCompCor >= .5) %>%
                                          ungroup() %>%
                                          mutate(theta = ifelse(direction == "targetToRef",-theta,theta),
                                                 x = ifelse(direction == "targetToRef",-x,x),
                                                 y = ifelse(direction == "targetToRef",-y,y)) %>%
                                          summarise(theta = median(theta),
                                                    x = median(x),
                                                    y = median(y))
                                        
                                        target <- scanPhaseShift(target,
                                                                 rotation = phaseAlignment$theta,
                                                                 rowTranslation = phaseAlignment$y,
                                                                 colTranslation = phaseAlignment$x)
                                        
                                        print(paste0(refName," vs. ",targetName))
                                        
                                        refToTargetComparison <- tryCatch({
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = ref,
                                                                           target = target,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "refToTarget",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "refToTarget")
                                        })
                                        
                                        targetToRefComparison <- tryCatch(expr = {
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = target,
                                                                           target = ref,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "targetToRef",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "targetToRef")
                                        })
                                        
                                        comparisonData <- bind_rows(refToTargetComparison,
                                                                    targetToRefComparison)
                                        if(!any(is.na(comparisonData$cellIndex))){
                                          
                                          CMCs <- purrr::map_dfr(cross(.l = list("x" = seq(5,25,by = 5),
                                                                                 # "y" = seq(5,25,by = 5),
                                                                                 "corr" = seq(.3,.6,by = .05))),
                                                                 function(thresholds){
                                                                   
                                                                   comparisonData %>%
                                                                     group_by(comparisonName,
                                                                              direction) %>%
                                                                     mutate(originalMethodClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                                 x = x,
                                                                                                                 y = y,
                                                                                                                 theta = theta,
                                                                                                                 corr = pairwiseCompCor,
                                                                                                                 xThresh = thresholds$x,
                                                                                                                 yThresh = thresholds$x,
                                                                                                                 corrThresh = thresholds$corr,
                                                                                                                 thetaThresh = 6),
                                                                            highCMCClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                          x = x,
                                                                                                          y = y,
                                                                                                          theta = theta,
                                                                                                          corr = pairwiseCompCor,
                                                                                                          xThresh = thresholds$x,
                                                                                                          yThresh = thresholds$x,
                                                                                                          corrThresh = thresholds$corr,
                                                                                                          thetaThresh = 6,
                                                                                                          tau = 1)) %>%
                                                                     ungroup() %>%
                                                                     mutate(type = "match",
                                                                            xThresh = thresholds$x,
                                                                            yThresh = thresholds$x,
                                                                            corrThresh = thresholds$corr,
                                                                            thetaThresh = 6)
                                                                   
                                                                 })
                                        }
                                        else{
                                          CMCs <- comparisonData %>%
                                            mutate(originalMethodCount = NA,
                                                   highCMCCount = NA,
                                                   type = "match",
                                                   xThresh = NA,
                                                   yThresh = NA,
                                                   corrThresh = NA,
                                                   thetaThresh = NA)
                                        }
                                        
                                        ret <- list("comparisonData" = comparisonData,
                                                    "CMCs" = CMCs)
                                        retName <- paste0("~/cmas/Iterative Alignment Experiment/topMatchAlignedOnceComparisonData/",
                                                          paste0(refName,"_vs_",targetName),".Rdata") 
                                        
                                        save(ret,
                                             file = retName)
                                        
                                        # return(list("comparisonData" = comparisonData,
                                        #             "CMCs" = CMCs))
                                        
                                      })
                  })

future:::ClusterRegistry("stop")
```


Repeat again with previously aligned values

```{r}
future::plan(future::multisession(workers = future::availableCores() - 10))

# topMatchGroup4Comparisons_64Cells_alignedOnce <- 
furrr::future_map(1:length(topMatchProcessedGroup4_masked),
                  # purrr::map(1:length(topMatchProcessedGroup4_masked),
                  function(refInd){
                    furrr::future_map(1:length(topMatchProcessedGroup4_masked),
                                      # purrr::map(1:length(topMatchProcessedGroup4_masked),
                                      function(targetInd){
                                        
                                        # browser()
                                        
                                        refName <- names(topMatchProcessedGroup4_masked[refInd])
                                        targetName <- names(topMatchProcessedGroup4_masked[targetInd])
                                        
                                        ref <- topMatchProcessedGroup4_masked[[refInd]]
                                        target <- topMatchProcessedGroup4_masked[[targetInd]]
                                        
                                        #load previous iteration's alignment data
                                        load(paste0("~/cmas/Iterative Alignment Experiment/topMatchAlignedOnceComparisonData/",
                                                    paste0(refName,"_vs_",targetName),".Rdata"))
                                        
                                        phaseAlignment <- ret$comparisonData %>%
                                          group_by(cellIndex,direction) %>%
                                          filter(pairwiseCompCor == max(pairwiseCompCor) & pairwiseCompCor >= .5) %>%
                                          ungroup() %>%
                                          mutate(theta = ifelse(direction == "targetToRef",-theta,theta),
                                                 x = ifelse(direction == "targetToRef",-x,x),
                                                 y = ifelse(direction == "targetToRef",-y,y)) %>%
                                          summarise(theta = median(theta),
                                                    x = median(x),
                                                    y = median(y))
                                        
                                        target <- scanPhaseShift(target,
                                                                 rotation = phaseAlignment$theta,
                                                                 rowTranslation = phaseAlignment$y,
                                                                 colTranslation = phaseAlignment$x)
                                        
                                        print(paste0(refName," vs. ",targetName))
                                        
                                        refToTargetComparison <- tryCatch({
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = ref,
                                                                           target = target,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "refToTarget",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "refToTarget")
                                        })
                                        
                                        targetToRefComparison <- tryCatch(expr = {
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = target,
                                                                           target = ref,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "targetToRef",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "targetToRef")
                                        })
                                        
                                        comparisonData <- bind_rows(refToTargetComparison,
                                                                    targetToRefComparison)
                                        if(!any(is.na(comparisonData$cellIndex))){
                                          
                                          CMCs <- purrr::map_dfr(cross(.l = list("x" = seq(5,25,by = 5),
                                                                                 # "y" = seq(5,25,by = 5),
                                                                                 "corr" = seq(.3,.6,by = .05))),
                                                                 function(thresholds){
                                                                   
                                                                   comparisonData %>%
                                                                     group_by(comparisonName,
                                                                              direction) %>%
                                                                     mutate(originalMethodClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                                 x = x,
                                                                                                                 y = y,
                                                                                                                 theta = theta,
                                                                                                                 corr = pairwiseCompCor,
                                                                                                                 xThresh = thresholds$x,
                                                                                                                 yThresh = thresholds$x,
                                                                                                                 corrThresh = thresholds$corr,
                                                                                                                 thetaThresh = 6),
                                                                            highCMCClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                          x = x,
                                                                                                          y = y,
                                                                                                          theta = theta,
                                                                                                          corr = pairwiseCompCor,
                                                                                                          xThresh = thresholds$x,
                                                                                                          yThresh = thresholds$x,
                                                                                                          corrThresh = thresholds$corr,
                                                                                                          thetaThresh = 6,
                                                                                                          tau = 1)) %>%
                                                                     ungroup() %>%
                                                                     mutate(type = "match",
                                                                            xThresh = thresholds$x,
                                                                            yThresh = thresholds$x,
                                                                            corrThresh = thresholds$corr,
                                                                            thetaThresh = 6)
                                                                   
                                                                 })
                                        }
                                        else{
                                          CMCs <- comparisonData %>%
                                            mutate(originalMethodCount = NA,
                                                   highCMCCount = NA,
                                                   type = "match",
                                                   xThresh = NA,
                                                   yThresh = NA,
                                                   corrThresh = NA,
                                                   thetaThresh = NA)
                                        }
                                        
                                        ret <- list("comparisonData" = comparisonData,
                                                    "CMCs" = CMCs)
                                        retName <- paste0("~/cmas/Iterative Alignment Experiment/topMatchAlignedTwiceComparisonData/",
                                                          paste0(refName,"_vs_",targetName),".Rdata") 
                                        
                                        save(ret,
                                             file = retName)
                                        
                                        # return(list("comparisonData" = comparisonData,
                                        #             "CMCs" = CMCs))
                                        
                                      })
                  })

future:::ClusterRegistry("stop")
```


Now perform cross-group comparisons


```{r}
future::plan(future::multisession(workers = future::availableCores() - 10))



sensofarProcessedGroup4_masked_downSample <- purrr::map(sensofarFilesGroup4,
                                                        function(fileName){
                                                          
                                                          print(fileName)
                                                          
                                                          dat <- x3p_read(fileName)
                                                          
                                                          maskBackground <- toupper(dat$matrix.info$Mask$Background[[1]])
                                                          
                                                          if(all(str_length(unique(as.vector(dat$mask))) > 7) & any(str_detect(unique(as.vector(dat$mask)),"FF$"))){
                                                            
                                                            maskBackground <- paste0(maskBackground,"FF")
                                                            
                                                          }
                                                          
                                                          # browser()
                                                          
                                                          dat <- dat %>%
                                                            x3p_delete(mask_vals = maskBackground) %>%
                                                            x3p_interpolate(resx = 1.8434e-06) %>%
                                                            preProcess_removeTrend(statistic = "quantile",
                                                                                   tau = .5,
                                                                                   method = "fn") %>%
                                                            preProcess_gaussFilter() %>% 
                                                            x3p_sample() %>% 
                                                            preProcess_removeTrend(statistic = "quantile",
                                                                                   tau = .5,
                                                                                   method = "fn") %>%
                                                            preProcess_gaussFilter() %>% 
                                                            x3p_sample() %>%
                                                            x3p_trim_na()
                                                          
                                                          dat$mask <- NULL
                                                          
                                                          return(dat)
                                                          
                                                        }) %>%
  set_names(sensofarNamesGroup4)

future:::ClusterRegistry("stop")

# topMatchProcessedGroup4_masked <- topMatchProcessedGroup4_masked[-11]

x3pListPlot(sensofarProcessedGroup4_masked_downSample,
            type = "list")
```

```{r}
load("~/cmas/DFSC Pre-Rotate Scans by Polar Domain Estimation Experiment/DFSC_64Cells_comparisonData.RData")
rm(sensofarGroup4Comparisons_64Cells)
rm(topMatchGroup4Comparisons_64Cells)
# rm(crossGroup4Comparisons_64Cells)
```

```{r}
# future::plan(future::multisession(workers = future::availableCores() - 10))

# topMatchGroup4Comparisons_64Cells_alignedOnce <- 
# furrr::future_map(1:length(sensofarProcessedGroup4_masked_downSample),
                  purrr::map(1:length(sensofarProcessedGroup4_masked_downSample),
                  function(refInd){
                    # furrr::future_map(1:length(topMatchProcessedGroup4_masked),
                                      purrr::map(1:length(topMatchProcessedGroup4_masked),
                                      function(targetInd){
                                        
                                        # browser()
                                        
                                        refName <- names(sensofarProcessedGroup4_masked_downSample[refInd])
                                        targetName <- names(topMatchProcessedGroup4_masked[targetInd])
                                        
                                        ref <- sensofarProcessedGroup4_masked_downSample[[refInd]]
                                        target <- topMatchProcessedGroup4_masked[[targetInd]]
                                        
                                        phaseAlignment <- crossGroup4Comparisons_64Cells[[refInd]][[targetInd]]$comparisonData %>%
                                          group_by(cellIndex,direction) %>%
                                          filter(pairwiseCompCor == max(pairwiseCompCor) & pairwiseCompCor >= .5) %>%
                                          ungroup() %>%
                                          mutate(theta = ifelse(direction == "targetToRef",-theta,theta),
                                                 x = ifelse(direction == "targetToRef",-x,x),
                                                 y = ifelse(direction == "targetToRef",-y,y)) %>%
                                          summarise(theta = median(theta),
                                                    x = median(x),
                                                    y = median(y))
                                        
                                        target <- scanPhaseShift(target,
                                                                 rotation = phaseAlignment$theta,
                                                                 rowTranslation = phaseAlignment$y,
                                                                 colTranslation = phaseAlignment$x)
                                        
                                        target$header.info$incrementY <- ref$header.info$incrementY
                                        target$header.info$incrementX <- ref$header.info$incrementX
                                        
                                        print(paste0(refName," vs. ",targetName))
                                        
                                        refToTargetComparison <- tryCatch({
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = ref,
                                                                           target = target,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "refToTarget",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "refToTarget")
                                        })
                                        
                                        targetToRefComparison <- tryCatch(expr = {
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = target,
                                                                           target = ref,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "targetToRef",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "targetToRef")
                                        })
                                        
                                        comparisonData <- bind_rows(refToTargetComparison,
                                                                    targetToRefComparison)
                                        if(!any(is.na(comparisonData$cellIndex))){
                                          
                                          CMCs <- purrr::map_dfr(cross(.l = list("x" = seq(5,25,by = 5),
                                                                                 # "y" = seq(5,25,by = 5),
                                                                                 "corr" = seq(.3,.6,by = .05))),
                                                                 function(thresholds){
                                                                   
                                                                   comparisonData %>%
                                                                     group_by(comparisonName,
                                                                              direction) %>%
                                                                     mutate(originalMethodClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                                 x = x,
                                                                                                                 y = y,
                                                                                                                 theta = theta,
                                                                                                                 corr = pairwiseCompCor,
                                                                                                                 xThresh = thresholds$x,
                                                                                                                 yThresh = thresholds$x,
                                                                                                                 corrThresh = thresholds$corr,
                                                                                                                 thetaThresh = 6),
                                                                            highCMCClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                          x = x,
                                                                                                          y = y,
                                                                                                          theta = theta,
                                                                                                          corr = pairwiseCompCor,
                                                                                                          xThresh = thresholds$x,
                                                                                                          yThresh = thresholds$x,
                                                                                                          corrThresh = thresholds$corr,
                                                                                                          thetaThresh = 6,
                                                                                                          tau = 1)) %>%
                                                                     ungroup() %>%
                                                                     mutate(type = "match",
                                                                            xThresh = thresholds$x,
                                                                            yThresh = thresholds$x,
                                                                            corrThresh = thresholds$corr,
                                                                            thetaThresh = 6)
                                                                   
                                                                 })
                                        }
                                        else{
                                          CMCs <- comparisonData %>%
                                            mutate(originalMethodCount = NA,
                                                   highCMCCount = NA,
                                                   type = "match",
                                                   xThresh = NA,
                                                   yThresh = NA,
                                                   corrThresh = NA,
                                                   thetaThresh = NA)
                                        }
                                        
                                        ret <- list("comparisonData" = comparisonData,
                                                    "CMCs" = CMCs)
                                        retName <- paste0("~/cmas/Iterative Alignment Experiment/crossGroupAlignedOnceComparisonData/",
                                                          paste0(refName,"_vs_",targetName),".Rdata") 
                                        
                                        save(ret,
                                             file = retName)
                                        
                                        # return(list("comparisonData" = comparisonData,
                                        #             "CMCs" = CMCs))
                                        
                                      })
                  })

# future:::ClusterRegistry("stop")
```


Repeat again with previously aligned values

```{r}
# future::plan(future::multisession(workers = future::availableCores() - 10))

# topMatchGroup4Comparisons_64Cells_alignedOnce <- 
# furrr::future_map(1:length(sensofarProcessedGroup4_masked_downSample),
                  purrr::map(1:length(sensofarProcessedGroup4_masked_downSample),
                  function(refInd){
                    # furrr::future_map(1:length(topMatchProcessedGroup4_masked),
                                      purrr::map(1:length(topMatchProcessedGroup4_masked),
                                      function(targetInd){
                                        
                                        # browser()
                                        
                                        refName <- names(sensofarProcessedGroup4_masked_downSample[refInd])
                                        targetName <- names(topMatchProcessedGroup4_masked[targetInd])
                                        
                                        ref <- sensofarProcessedGroup4_masked_downSample[[refInd]]
                                        target <- topMatchProcessedGroup4_masked[[targetInd]]
                                        
                                        #load previous iteration's alignment data
                                        load(paste0("~/cmas/Iterative Alignment Experiment/crossGroupAlignedOnceComparisonData/",
                                                    paste0(refName,"_vs_",targetName),".Rdata"))
                                        
                                        phaseAlignment <- ret$comparisonData %>%
                                          group_by(cellIndex,direction) %>%
                                          filter(pairwiseCompCor == max(pairwiseCompCor) & pairwiseCompCor >= .5) %>%
                                          ungroup() %>%
                                          mutate(theta = ifelse(direction == "targetToRef",-theta,theta),
                                                 x = ifelse(direction == "targetToRef",-x,x),
                                                 y = ifelse(direction == "targetToRef",-y,y)) %>%
                                          summarise(theta = median(theta),
                                                    x = median(x),
                                                    y = median(y))
                                        
                                        target <- scanPhaseShift(target,
                                                                 rotation = phaseAlignment$theta,
                                                                 rowTranslation = phaseAlignment$y,
                                                                 colTranslation = phaseAlignment$x)
                                        
                                        target$header.info$incrementY <- ref$header.info$incrementY
                                        target$header.info$incrementX <- ref$header.info$incrementX
                                        
                                        print(paste0(refName," vs. ",targetName))
                                        
                                        refToTargetComparison <- tryCatch({
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = ref,
                                                                           target = target,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "refToTarget",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "refToTarget")
                                        })
                                        
                                        targetToRefComparison <- tryCatch(expr = {
                                          map_dfr(seq(-30,30,by = 3),
                                                  function(theta){
                                                    comparison_allTogether(reference = target,
                                                                           target = ref,
                                                                           theta = theta,
                                                                           numCells = 64)
                                                  })  %>%
                                            mutate(direction = "targetToRef",
                                                   comparisonName = paste0(refName," vs. ",targetName))
                                        },
                                        error = function(e){
                                          data.frame(cellIndex = NA,fft_ccf = NA,pairwiseCompCor = NA,
                                                     comparisonName = paste0(refName," vs. ",targetName),direction = "targetToRef")
                                        })
                                        
                                        comparisonData <- bind_rows(refToTargetComparison,
                                                                    targetToRefComparison)
                                        if(!any(is.na(comparisonData$cellIndex))){
                                          
                                          CMCs <- purrr::map_dfr(cross(.l = list("x" = seq(5,25,by = 5),
                                                                                 # "y" = seq(5,25,by = 5),
                                                                                 "corr" = seq(.3,.6,by = .05))),
                                                                 function(thresholds){
                                                                   
                                                                   comparisonData %>%
                                                                     group_by(comparisonName,
                                                                              direction) %>%
                                                                     mutate(originalMethodClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                                 x = x,
                                                                                                                 y = y,
                                                                                                                 theta = theta,
                                                                                                                 corr = pairwiseCompCor,
                                                                                                                 xThresh = thresholds$x,
                                                                                                                 yThresh = thresholds$x,
                                                                                                                 corrThresh = thresholds$corr,
                                                                                                                 thetaThresh = 6),
                                                                            highCMCClassif = decision_CMC(cellIndex = cellIndex,
                                                                                                          x = x,
                                                                                                          y = y,
                                                                                                          theta = theta,
                                                                                                          corr = pairwiseCompCor,
                                                                                                          xThresh = thresholds$x,
                                                                                                          yThresh = thresholds$x,
                                                                                                          corrThresh = thresholds$corr,
                                                                                                          thetaThresh = 6,
                                                                                                          tau = 1)) %>%
                                                                     ungroup() %>%
                                                                     mutate(type = "match",
                                                                            xThresh = thresholds$x,
                                                                            yThresh = thresholds$x,
                                                                            corrThresh = thresholds$corr,
                                                                            thetaThresh = 6)
                                                                   
                                                                 })
                                        }
                                        else{
                                          CMCs <- comparisonData %>%
                                            mutate(originalMethodCount = NA,
                                                   highCMCCount = NA,
                                                   type = "match",
                                                   xThresh = NA,
                                                   yThresh = NA,
                                                   corrThresh = NA,
                                                   thetaThresh = NA)
                                        }
                                        
                                        ret <- list("comparisonData" = comparisonData,
                                                    "CMCs" = CMCs)
                                        retName <- paste0("~/cmas/Iterative Alignment Experiment/crossGroupAlignedTwiceComparisonData/",
                                                          paste0(refName,"_vs_",targetName),".Rdata") 
                                        
                                        save(ret,
                                             file = retName)
                                        
                                        # return(list("comparisonData" = comparisonData,
                                        #             "CMCs" = CMCs))
                                        
                                      })
                  })

# future:::ClusterRegistry("stop")
```

